# apiVersion: kubeflow.org/v2beta1
# kind: MPIJob
# metadata:
#   name: pi-test
#   labels:
#     kueue.x-k8s.io/queue-name: default-queue
# spec:
#   slotsPerWorker: 1
#   runPolicy:
#     cleanPodPolicy: Running
#     ttlSecondsAfterFinished: 60
#   sshAuthMountPath: /home/mpiuser/.ssh
#   mpiReplicaSpecs:
#     Launcher:
#       replicas: 1
#       template:
#         spec:
#           containers:
#           - image: mpioperator/mpi-pi:openmpi
#             name: mpi-launcher
#             command:
#             - mpirun
#             args:
#             - -n
#             - "4"
#             - /home/mpiuser/pi
#             resources:
#               limits:
#                 cpu: 1
#                 memory: 1Gi
#     Worker:
#       replicas: 4
#       template:
#         spec:
#           containers:
#           - image: mpioperator/mpi-pi:openmpi
#             name: mpi-worker
#             command:
#             - /usr/sbin/sshd
#             args:
#             - -De
#             - -f
#             - /home/mpiuser/.sshd_config
#             resources:
#               limits:
#                 cpu: 1
#                 memory: 1Gi
#
apiVersion: kubeflow.org/v2beta1
kind: MPIJob
metadata:
  name: pi-test-v2
  labels:
    kueue.x-k8s.io/queue-name: default-queue
spec:
  slotsPerWorker: 1
  runPolicy:
    cleanPodPolicy: Running
    ttlSecondsAfterFinished: 300
  sshAuthMountPath: /home/mpiuser/.ssh
  mpiReplicaSpecs:
    Launcher:
      replicas: 1
      template:
        spec:
          restartPolicy: Never
          containers:
          - name: mpi-launcher
            image: mpioperator/mpi-pi:openmpi
            securityContext:
              runAsUser: 1000
            command:
            - mpirun
            args:
            - -n
            - "4"
            - /home/mpiuser/pi
            resources:
              requests:
                cpu: 500m
                memory: 512Mi
              limits:
                cpu: 1
                memory: 1Gi
    Worker:
      replicas: 4
      template:
        spec:
          restartPolicy: Never
          containers:
          - name: mpi-worker
            image: mpioperator/mpi-pi:openmpi
            securityContext:
              runAsUser: 1000
            command:
            - /usr/sbin/sshd
            args:
            - -De
            - -f
            - /home/mpiuser/.sshd_config
            resources:
              requests:
                cpu: 500m
                memory: 512Mi
              limits:
                cpu: 1
                memory: 1Gi
