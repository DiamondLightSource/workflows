apiVersion: argoproj.io/v1alpha1
kind: Workflow
metadata:
  generateName: mpi-kueue-test-
spec:
  entrypoint: mpi-job
  podSpecPatch: | 
    {"initContainers":[{"name":"init","volumeMounts":[{"name":"init-temp-dir","mountPath":"/tmp"}]}],"volumes":[{"name":"init-temp-dir","emptyDir":{}}]}
  templates:
  - name: mpi-job
    resource:
      action: create
      successCondition: status.replicaStatuses.Launcher.succeeded == 1
      failureCondition: status.replicaStatuses.Launcher.failed > 0
      manifest: | 
        apiVersion: kubeflow.org/v2beta1
        kind: MPIJob
        metadata:
          generateName: pi
          labels:
            kueue.x-k8s.io/queue-name: default-queue
        spec:
          slotsPerWorker: 1
          runPolicy:
            cleanPodPolicy: Running
            ttlSecondsAfterFinished: 60
          sshAuthMountPath: /home/mpiuser/.ssh
          mpiReplicaSpecs:
            Launcher:
              replicas: 1
              template:
                spec:
                  containers:
                  - image: mpioperator/mpi-pi:openmpi
                    name: mpi-launcher
                    securityContext:
                      runAsUser: 1000
                    command:
                    - mpirun
                    args:
                    - -n
                    - "4"
                    - /home/mpiuser/pi
                    resources:
                      limits:
                        cpu: 1
                        memory: 1Gi
            Worker:
              replicas: 4
              template:
                spec:
                  containers:
                  - image: mpioperator/mpi-pi:openmpi
                    name: mpi-worker
                    securityContext:
                      runAsUser: 1000
                    command:
                    - /usr/sbin/sshd
                    args:
                    - -De
                    - -f
                    - /home/mpiuser/.sshd_config
                    resources:
                      limits:
                        cpu: 1
                        memory: 1Gi

