apiVersion: v1
kind: Service
metadata:
  name: oidc-bff
  namespace: {{ .Release.Namespace }}
spec:
  type: ClusterIP
  selector:
    app: oidc-bff
  ports:
    - name: oidc-bff
      port: 80
      targetPort: oidc-bff
      protocol: TCP
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: oidc-bff
spec:
  replicas: 1
  selector:
    matchLabels:
      app: oidc-bff
  template:
    metadata:
      labels:
        app: oidc-bff
    spec:
      imagePullSecrets: {{ include "common.images.renderPullSecrets" (dict "images" (list $.Values.oidcBff.image) "context" $ ) }}
      containers:
        - name: oidc-bff
          image: {{ include "common.images.image" ( dict "imageRoot" $.Values.oidcBff.image "global" $.Values.global "chart" $.Chart ) }}
          imagePullPolicy: {{ $.Values.oidcBff.image.pullPolicy }}
          ports:
            - containerPort: 80
          livenessProbe:
            httpGet:
              path: /healthcheck
              port: 80
            initialDelaySeconds: 3
            periodSeconds: 3
          readinessProbe:
            httpGet:
              path: /healthcheck
              port: 80
            initialDelaySeconds: 5
            periodSeconds: 5
          startupProbe:
            httpGet:
             path: /healthcheck
             port: 80
            failureThreshold: 3
            periodSeconds: 5
          env:
            - name: WORKFLOWS_OIDC_BFF_CONFIG
              value: "/etc/oidc-bff/config.yaml"
            - name: RUST_BACKTRACE
              value: "1"
          volumeMounts:
            - name: oidc-bff-config
              mountPath: /etc/oidc-bff
              readOnly: true
      volumes:
        - name: oidc-bff-config
          secret:
            secretName: {{ .Values.oidcBff.configuration.secretName | default "oidc-bff-config" }}
            items:
              - key: config.yaml
                path: config.yaml
---
apiVersion: bitnami.com/v1alpha1
kind: SealedSecret
metadata:
  creationTimestamp: null
  name: oidc-bff-config
  namespace: workflows
spec:
  encryptedData:
    config.yaml: AgBBtsyB0B27DM2hJHCJ6Ns6LPPDtVI5x+sQyr13SzezaXi2IbU/V+ZuVxlOUlrB0rO2e8HPK7w41W0VumgG5EnELhJZpUpn0voLGlvfaIVvJVz2PwLqoDLw0D2KuF7EpakRFdP4kEZLFcOjFwTotNbfTUaSZ8wrwi2CTQ+eOzF6HGwGyiQ0dhWt5g8Gx1w8JbtP6GYcJMdfFQkjQE/6moz1pYrPwgWeL0IXRejsSorFFqCfJ2ONYYm//90wYpSmGxo1oTExNNoJ8emJgawE/HIDZI20GGU+IedXus2jH2i5XUQ+vu+S+0mMcXblyj3yzJGRBjfrCgfRmjLdCnGfLoIEV1trafuno8ARteaSGRfyvU3+QBZhIg4XmeivJZdNOu5vr4BabCO8gZ9YiKUDJRqda5MusMOvqGITTIFSocZNXQnoiX5uwrDOmrJJYcupiiZMfMHr6fGKY3QxOUlvSjJNcwSru0aaw/MyMingLRMRQxT6v72Y//snS1JGZQCkWDCSz95RjgtxqxoIx+e4vKXlWHldXS/80BzBlmJD8EUwE7gWNZkE4QFSVakh57FF+DTcQO049KaC9S1N3s0NABL0a+fJw2BNYf0MRRhGz0xwCn/JZZO41+vDMOtTIOVIN0ywKOSdyRc7hvknCe4/C+GvZHZqvW8xOQwPXRP1HsuBveDkeVm+D04YGfInbR+51YG/CtUaBOKbaoWXVQGMI5A0O/x5VKNxx0tHVKiLhbQ4otIF1CBZxMaKwSvUnzHAdpwPCHdX/niND/gfD45/T6VTMzgzjEP5Dzm/ErCbyyB8XACbTVDSDDp9nEQ8j0Gk9hOXoKDAPM/RwnB4Kq2wj592PgTciaZySo+Hw06zip8fdjGQZ2oZLTB7l/w/JAbTXHkKKd+KtMIZQZb38NBIkt9VAAG/p3rH53hMhcfuSputsM/3N5rFfmKKsE4bmpM1nnvZHhcZ2uhY0gBV5VwXp2ALG85M4A1BWLkXOz84RWAe8g9K2VZnlXK39ZhhpHO+k2KdBUr6tMgD3cJy7Zb4wrmlnMJqwqL/NpxK20hDFJMAHIoQcpaL004fBU64sgfHudUgEev1m4az3PeB+7xb0/dLTMgxwRMYqWuc6xrZ5KRYK/ZFtVaehJkOAV3QC14mPr2PD6VbckzYMHd99klMDcV4zbsp6t8JQ9vW1/ClPOhRK8GvqYw2LQmfYbOXVOUsZ4rJ1wGw6UrWlPv921a1mkWbrcFgSOViboGk+G+FZGZTwslKAcmKIHUO
  template:
    metadata:
      creationTimestamp: null
      name: oidc-bff-config
      namespace: workflows
    type: Opaque