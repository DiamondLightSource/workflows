apiVersion: v1
kind: ServiceAccount
metadata:
  name: secret-reader
  namespace: workflows
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: secret-reader
  namespace: workflows
rules:
  - apiGroups: [""]
    resources: ["secrets", "services"]
    verbs: ["get", "list", "create", "update"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: secret-reader-binding
  namespace: workflows
subjects:
  - kind: ServiceAccount
    name: secret-reader
    namespace: workflows
roleRef:
  kind: Role
  name: secret-reader
  apiGroup: rbac.authorization.k8s.io
---
apiVersion: batch/v1
kind: Job
metadata:
  name: copy-secret
  namespace: workflows
spec:
  template:
    spec:
      serviceAccountName: secret-reader
      restartPolicy: Never
      containers:
        - name: copy-secret
          image: alpine/kubectl:latest
          env:
            - name: SECRET_NAME
              value: "s3-artifact"
            - name: NEW_SECRET_NAME
              value: "artifact-s3"
            - name: SOURCE_NAMESPACE
              value: "workflows"
            - name: DESTINATION_NAMESPACE
              value: "workflows"
          command:
            - /bin/sh
            - -c
            - |
              set -euo pipefail
              SRC_DATA=$(kubectl get secret "$SECRET_NAME" -n "$SOURCE_NAMESPACE" -o jsonpath='{.data}')

              # Try to get destination secret data
              DEST_DATA=$(kubectl get secret "$NEW_SECRET_NAME" -n "$DESTINATION_NAMESPACE" -o jsonpath='{.data}' || echo "")

              # Compare
              if [ "$SRC_DATA" = "$DEST_DATA" ]; then
                echo "Secret unchanged, skipping copy."
              else
                echo "Secret changed or missing, copying..."
                # Get source secret YAML
                kubectl get secret "$SECRET_NAME" -n "$SOURCE_NAMESPACE" -o yaml > /tmp/secret.yaml
                # Remove namespace
                sed -i '/namespace:/d' /tmp/secret.yaml
                # Rename if needed
                sed -i "s/^\([[:space:]]*name:[[:space:]]*\)$SECRET_NAME$/\1$NEW_SECRET_NAME/" /tmp/secret.yaml
                # Apply to destination namespace
                kubectl apply -n "$DESTINATION_NAMESPACE" -f /tmp/secret.yaml
                echo "Secret copied."
              fi