# Design: Policy creates LocalQueues for new matching namespaces; post-install Job handles existing ones.
# This avoids Kyverno's generateExisting limitations with large namespace counts.
# Note: May fail if matched namespaces grow excessively from zero (clean install); upstream Kyverno bug.
apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: generate-default-localqueue
spec:
  validationFailureAction: Enforce
  rules:
  - name: create-localqueue-for-session
    match:
      any:
      - resources:
          kinds:
          - Namespace
          selector:
            matchLabels:
              app.kubernetes.io/managed-by: sessionspaces
    generate:
      synchronize: true
      apiVersion: kueue.x-k8s.io/v1beta1
      kind: LocalQueue
      name: default-queue
      namespace: "{{ `{{request.object.metadata.name}}` }}"
      data:
        spec:
          clusterQueue: default-queue
