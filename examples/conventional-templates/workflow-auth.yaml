apiVersion: argoproj.io/v1alpha1
kind: ClusterWorkflowTemplate
metadata:
  name: workflow-of-workflows
  labels:
    workflows.diamond.ac.uk/science-group: workflows-examples
  annotations:
    workflows.argoproj.io/title: Workflow Of Workflows
spec:
  entrypoint: entry
  templates:
  - name: entry
    dag:
      tasks:
      - name: start-auth
        template: auth
      - name: delay
        template: wait
        dependencies: [start-auth]
      - name: conditional-steps-workflow
        templateRef:
          name: conditional-steps
          template: workflow-entry
          clusterScope: true
        dependencies: [delay]

  - name: wait
    script:
      image: docker.io/library/bash:5.3
      command: [bash]
      source: |
        echo "Waiting for initial access token to expire..."
        sleep 60

  - name: auth
    daemon: true
    retryStrategy:
      limit: 10
    container:
      image: ghcr.io/diamondlightsource/workflows-auth-daemon:0.1.0
      readinessProbe:
        httpGet:
          path: /healthz
          port: 8080
        initialDelaySeconds: 5
        periodSeconds: 1
      env:
        - name: PORT
          value: "8080"
        - name: AUTH_DOMAIN
          value: https://authn.diamond.ac.uk/realms/master
        - name: CLIENT_ID
          value: workflows-cluster-staging
          # value: workflows-cluster
        - name: LOG_LEVEL
          value: debug
        - name: GRAPH_URL
          value: https://staging.workflows.diamond.ac.uk/graphql
          # value: https://workflows.diamond.ac.uk/graphql
        - name: TOKEN
          valueFrom:
            secretKeyRef:
              name: token
              key: token
      args:
        - serve
